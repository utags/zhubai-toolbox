import { $, addElement } from "browser-extension-utils"

import { getAllPostListFromCache } from "./post-list"

export async function showToolbar() {
  const aside =
    $("#right_aside") ||
    addElement(document.body, "aside", {
      id: "right_aside",
    })

  const container =
    $("#right_aside .toolbar") ||
    addElement(aside, "div", {
      class: "toolbar",
    })

  container.innerHTML = ""

  const currentId = (/posts\/(\d+)/.exec(location.pathname) || [])[1]
  let previousId
  let nextId

  const postList = await getAllPostListFromCache()

  for (let i = 0; i < postList.length; i++) {
    const post = postList[i]
    if (post.id === currentId) {
      if (i > 0) {
        nextId = postList[i - 1].id
      }

      if (i < postList.length - 1) {
        previousId = postList[i + 1].id
      }
    }
  }

  addElement(container, "a", {
    class: previousId ? "button" : "button disabled",
    href: previousId ? "/posts/" + previousId : "",
    title: "上一期",
    innerHTML: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M10.4699 5.45621C11.136 5.03993 11.9999 5.51878 11.9999 6.30421V11.5353C12.0782 11.3852 12.1972 11.2517 12.3567 11.152L21.4699 5.45621C22.136 5.03993 22.9999 5.51878 22.9999 6.30421V17.6957C22.9999 18.4811 22.136 18.96 21.4699 18.5437L12.3567 12.848C12.1972 12.7482 12.0782 12.6147 11.9999 12.4647V17.6957C11.9999 18.4811 11.136 18.96 10.4699 18.5437L1.35672 12.848C0.730053 12.4563 0.730051 11.5436 1.35672 11.152L10.4699 5.45621ZM3.77351 12L9.99991 8.10845V15.8915L3.77351 12ZM20.9999 8.10845L14.7735 12L20.9999 15.8915V8.10845Z" fill="black"/>
</svg>`,
    onclick(event) {
      if (!previousId) {
        event.preventDefault()
      }
    },
  })
  addElement(container, "a", {
    class: nextId ? "button" : "button disabled",
    href: nextId ? "/posts/" + nextId : "",
    title: "下一期",
    innerHTML: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M2.53 18.5437C1.86395 18.96 1 18.4811 1 17.6957V6.30421C1 5.51878 1.86395 5.03993 2.53 5.45621L11.6432 11.152C11.8028 11.2517 11.9217 11.3852 12 11.5353V6.30421C12 5.51878 12.864 5.03993 13.53 5.45621L22.6432 11.152C23.2699 11.5436 23.2699 12.4563 22.6432 12.848L13.53 18.5437C12.864 18.96 12 18.4811 12 17.6957V12.4647C11.9217 12.6147 11.8028 12.7482 11.6432 12.848L2.53 18.5437ZM9.22641 12L3 15.8915V8.10846L9.22641 12ZM14 15.8915L20.2264 12L14 8.10846V15.8915Z" fill="black"/>
    </svg>
    `,
    onclick(event) {
      if (!nextId) {
        event.preventDefault()
      }
    },
  })
  addElement(container, "a", {
    class: "button",
    title: "回到顶部",
    innerHTML: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M5.48967 20.617L12.0002 17L18.5107 20.617C19.3368 21.0759 20.2797 20.2388 19.9219 19.3642L12.9257 2.26248C12.5868 1.43399 11.4136 1.43399 11.0746 2.26248L4.07848 19.3642C3.72069 20.2388 4.66363 21.0759 5.48967 20.617ZM7.00787 17.4856L12.0002 5.28219L16.9925 17.4856L12.9715 15.2517C12.3674 14.9161 11.6329 14.9161 11.0289 15.2517L7.00787 17.4856Z" fill="black"/>
</svg>`,
    onclick() {
      document.scrollingElement?.scrollTo({
        top: 0,
      })
    },
  })
  addElement(container, "a", {
    class: "button disabled",
    title: "设置（下个版本推出此功能）",
    innerHTML: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M12.0002 16C14.2094 16 16.0002 14.2091 16.0002 12C16.0002 9.79086 14.2094 8 12.0002 8C9.79109 8 8.00023 9.79086 8.00023 12C8.00023 14.2091 9.79109 16 12.0002 16ZM12.0002 14C13.1048 14 14.0002 13.1046 14.0002 12C14.0002 10.8954 13.1048 10 12.0002 10C10.8957 10 10.0002 10.8954 10.0002 12C10.0002 13.1046 10.8957 14 12.0002 14Z" fill="black"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M15.1182 1.86489L15.5203 4.81406C15.8475 4.97464 16.1621 5.1569 16.4623 5.35898L19.2185 4.23223C19.6814 4.043 20.2129 4.2248 20.463 4.65787L22.5901 8.34213C22.8401 8.77521 22.7318 9.3264 22.3365 9.63266L19.9821 11.4566C19.9941 11.6362 20.0002 11.8174 20.0002 12C20.0002 12.1826 19.9941 12.3638 19.9821 12.5434L22.3365 14.3673C22.7318 14.6736 22.8401 15.2248 22.5901 15.6579L20.463 19.3421C20.2129 19.7752 19.6814 19.957 19.2185 19.7678L16.4623 18.641C16.1621 18.8431 15.8475 19.0254 15.5203 19.1859L15.1182 22.1351C15.0506 22.6306 14.6274 23 14.1273 23H9.87313C9.37306 23 8.94987 22.6306 8.8823 22.1351L8.48014 19.1859C8.15296 19.0254 7.83835 18.8431 7.53818 18.641L4.78195 19.7678C4.31907 19.957 3.78756 19.7752 3.53752 19.3421L1.41042 15.6579C1.16038 15.2248 1.26869 14.6736 1.66401 14.3673L4.01841 12.5434C4.00636 12.3638 4.00025 12.1826 4.00025 12C4.00025 11.8174 4.00636 11.6362 4.01841 11.4566L1.66401 9.63266C1.26869 9.3264 1.16038 8.77521 1.41041 8.34213L3.53752 4.65787C3.78755 4.2248 4.31906 4.043 4.78195 4.23223L7.53818 5.35898C7.83835 5.1569 8.15296 4.97464 8.48014 4.81406L8.8823 1.86489C8.94987 1.3694 9.37306 1 9.87313 1H14.1273C14.6274 1 15.0506 1.3694 15.1182 1.86489ZM13.6826 6.14004L14.6392 6.60948C14.8842 6.72975 15.1201 6.86639 15.3454 7.01805L16.231 7.61423L19.1674 6.41382L20.4216 8.58619L17.9153 10.5278L17.9866 11.5905C17.9956 11.7255 18.0002 11.8621 18.0002 12C18.0002 12.1379 17.9956 12.2745 17.9866 12.4095L17.9153 13.4722L20.4216 15.4138L19.1674 17.5862L16.231 16.3858L15.3454 16.982C15.1201 17.1336 14.8842 17.2702 14.6392 17.3905L13.6826 17.86L13.2545 21H10.746L10.3178 17.86L9.36131 17.3905C9.11626 17.2702 8.88037 17.1336 8.6551 16.982L7.76954 16.3858L4.83313 17.5862L3.57891 15.4138L6.0852 13.4722L6.01392 12.4095C6.00487 12.2745 6.00024 12.1379 6.00024 12C6.00024 11.8621 6.00487 11.7255 6.01392 11.5905L6.0852 10.5278L3.57891 8.58619L4.83312 6.41382L7.76953 7.61423L8.6551 7.01805C8.88037 6.86639 9.11625 6.72976 9.36131 6.60949L10.3178 6.14004L10.746 3H13.2545L13.6826 6.14004Z" fill="black"/>
</svg>`,
    onclick() {},
  })

  // post list not loaded
  if (
    !postList ||
    postList.length === 0 ||
    (postList.length > 1 && !previousId && !nextId)
  ) {
    setTimeout(showToolbar, 100)
  }
}
